# 流式输出优化测试指南

## 🎯 优化目标

解决"只显示第一行，然后全部刷新"的问题，实现真正的渐进式流式显示。

---

## 🔧 已完成的优化

### 1. **部分对象解析** (videoAnalysis.ts)
- 新增 `tryParseIncompleteObject()` 函数
- 能够从不完整的 JSON 中提取已接收的字段
- 支持字段级别的流式更新

### 2. **增量更新机制** (VideoAnalyzer.vue)
- 使用 `Object.assign()` 原地更新对象字段
- 避免整行替换，保持 Vue 的细粒度响应式追踪
- 智能区分"新增项目"和"字段更新"

### 3. **节流优化**
- 100ms 节流间隔，减少不必要的 DOM 更新
- 新项目立即显示，字段更新按节流处理

### 4. **增强日志**
- 详细的数据流时间线
- 字段级别的变化追踪

---

## 🧪 测试步骤

### 1. 启动开发服务器

```bash
pnpm dev
```

### 2. 打开浏览器控制台

按 `F12` 或 `Cmd+Option+I`（Mac）打开开发者工具，切换到 Console 标签。

### 3. 上传视频并分析

上传一个测试视频（建议小于 10MB），点击"开始分析"。

### 4. 观察控制台输出

你应该看到类似这样的日志序列：

```
🚀 [流式输出] 开始接收数据流...
⏰ [流式输出] 开始时间: 2025-11-22T10:30:45.123Z
📦 [流式输出 #1] +0.15s | 1024字节 | 3行 | 累计1024字节
📦 [流式输出 #2] +0.32s | 512字节 | 2行 | 累计1536字节
✅ [JSON解析] 解析第 1 个完整项目
📋 [实时更新] 初始化，共 1 项
📦 [流式输出 #3] +0.48s | 768字节 | 3行 | 累计2304字节
⚡ [JSON解析] 解析第 1 个部分项目 (5 个字段)  ← 关键！部分对象
🔄 [字段更新] 第 1 项: 9 → 9 个字段              ← 字段更新
📦 [流式输出 #4] +0.65s | 1024字节 | 4行 | 累计3328字节
✅ [JSON解析] 解析第 2 个完整项目
📋 [实时更新] 新增第 2 项 (9 个字段)            ← 新项目
✅ [流式输出] 数据流接收完成
⏱️  [流式输出] 总耗时: 2.35s, 总数据块: 15, 总字节: 8192
```

### 5. 观察表格行为

#### ✅ **期望行为（优化后）**

1. **第一项出现**：
   - 首先显示部分字段（如 sequenceNumber, shotType）
   - 随后字段逐步填充（visualContent, voiceover 等）
   - **不应该看到整行闪烁或重绘**

2. **第二项出现**：
   - 在第一项下方**平滑添加**新行
   - 同样逐步填充字段
   - 表格自动滚动到底部

3. **字段更新**：
   - 长文本字段（如画面内容、口播）应该**原地增长**
   - 不应该看到整行"刷新"的效果

#### ❌ **问题行为（优化前）**

- 第一项完整出现后，后续项目整行刷新
- 字段更新时整行闪烁
- 表格出现明显的"重绘"效果

---

## 📊 关键指标

### 控制台日志分析

1. **部分对象解析**
   - 查找 `⚡ [JSON解析] 解析第 N 个部分项目` 日志
   - 字段数应该从少到多（如 3 → 5 → 9）

2. **字段更新**
   - 查找 `🔄 [字段更新]` 日志
   - 应该看到字段数递增

3. **数据流速度**
   - 查看时间戳增量（`+0.15s`, `+0.32s`...）
   - 如果间隔很小（< 50ms），说明数据到达很快，可能需要调整节流参数

### 网络面板分析

1. 切换到 Network 标签
2. 找到 `chat/completions` 请求
3. 点击 "Response" 查看原始流式响应
4. 观察 SSE 数据块的实际到达速度

---

## 🐛 常见问题排查

### 问题 1: 仍然看到整行刷新

**可能原因：**
- AI 生成速度太快，数据块在缓冲区中快速到达
- 节流间隔（100ms）太长

**解决方案：**
```typescript
// 在 VideoAnalyzer.vue 中调整节流间隔
const UPDATE_THROTTLE_MS = 50; // 从 100ms 降低到 50ms
```

### 问题 2: 没有看到部分对象日志

**可能原因：**
- AI 返回的 JSON 格式非常规范，每个对象都是一次性完整返回
- 网络速度太快，字段间隔很小

**解决方案：**
- 这是正常现象，说明 API 性能很好
- 优化仍然有效，只是跳过了部分对象阶段

### 问题 3: 控制台日志过多

**解决方案：**
```typescript
// 可以在 videoAnalysis.ts 中注释掉部分日志
// console.log(`📦 [流式输出 #${chunkCount}]...`);
```

---

## 🎨 进一步优化建议

### 1. 添加字段加载动画

在 `VideoAnalyzer.vue` 的 `<style>` 中添加：

```css
.script-row td {
  animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
  from { opacity: 0.3; }
  to { opacity: 1; }
}
```

### 2. 高亮新添加/更新的单元格

```typescript
// 在模板中添加条件类
<td :class="{ 'cell-updated': isFieldUpdated(item, 'visualContent') }">
  {{ item.visualContent }}
</td>
```

### 3. 显示加载骨架屏

对于部分对象，可以在空字段位置显示占位符：

```vue
<td>{{ item.voiceover || '...' }}</td>
```

---

## 📈 性能监控

### Chrome DevTools Performance

1. 打开 Performance 面板
2. 点击 Record
3. 开始视频分析
4. 停止录制
5. 查看：
   - Scripting 时间（应该很短）
   - Rendering 时间（DOM 更新频率）
   - Painting 时间（重绘次数）

---

## ✅ 验证清单

- [ ] 控制台日志显示详细的数据流时间线
- [ ] 看到 `⚡ [JSON解析] 部分项目` 日志（可选）
- [ ] 看到 `🔄 [字段更新]` 日志
- [ ] 表格行逐个添加，无整行刷新
- [ ] 长文本字段原地增长
- [ ] 表格自动滚动到底部
- [ ] 整体流畅，无明显卡顿

---

## 📝 反馈

如果遇到任何问题，请记录：
1. 控制台完整日志
2. 网络面板的响应数据
3. 视频文件大小和格式
4. 观察到的具体行为

Happy Testing! 🚀
